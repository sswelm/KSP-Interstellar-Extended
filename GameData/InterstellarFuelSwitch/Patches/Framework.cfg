// Common Framework for all IFS and 3rd party Tanks

//Tank registration: Legacy or BEFORE[IFSTanks]
//Primary Tank config: FOR[IFSTanks]
//Third party: AFTRER[IFSTanks]
//Cleanup: LAST

// Initial setup of all tanks

@PART[*]:HAS[#IFSTankVolume]:FOR[IFSTanks]
{
	%IFSVol5 = #$IFSTankVolume$
	@IFSVol5 *= 0.2					// Volume for resources with 5 FU per Liter

	%IFSpureLH2 = #$IFSTankVolume$
	@IFSpureLH2 *= 1.5

	MODULE
	{
		name = InterstellarMeshSwitch
		moduleID = IFSFuelMeshSwitcher
		switcherDescription = #LOC_IFS_FuelSwitch_switcherDescription
		useFuelSwitchModule = true
		affectColliders = false
		orderByIndexNames = true
		debugMode = false
		// rest inserted by AFTER patch
	}

	MODULE
	{
		name = InterstellarFuelSwitch
		moduleID = IFSFuelSwitcher
		//*defaultTank = LFO
		basePartMass = #$../mass$
		baseMassExponent = 2.7
		tweakscaleMassExponent = 3
		displayCurrentTankCost = true
		availableInFlight = true
		availableInEditor = true
		hasSwitchChooseOption = false
		showSwitchButtons = false
		showInfo = true
		hasGUI = false
		adaptiveTankSelection = true
		orderBySwitchName = true
		debugMode = false
		// a identifier and also shown in gui
		//*tankSwitchNames = LiquidFuel
		// what actually goes into tank
		//*resourceNames = LiquidFuel
		// how much
		//*resourceAmounts = #$../IFSVol5$
		// name of visual object for MeshSwitch
		//*visualObjectNames = LiquidFuel
		%IFSV=#$../IFSTankVolume$
	}
}

// Remove MeshSwitch if the tank def does not have unused visuals (optional, save space)
@PART[*]:HAS[#IFSTankVolume,~IFSUnusedVisualObjects]:FOR[IFSTanks] {
	!MODULE[InterstellarMeshSwitch]:HAS[#moduleID[IFSFuelMeshSwitcher]] {}
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]] {
		hasGUI = true
		hasSwitchChooseOption = true
	}
}


// Default Resource for each TankType.
// Must be before any other resource patch, because of the semicolons

// Default resources for any IFS-CC
@PART[*]:HAS[#IFSTankType[CC]]:FOR[IFSTanks] {
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]] {
		%tankSwitchNames = Lithium
		%resourceNames = Lithium
		%resourceAmounts = #$../IFSTankVolume$
		%visualObjectNames = 7Li,s
	}
}

// Default resources for any IFS-CT
@PART[*]:HAS[#IFSTankType[CT]]:FOR[IFSTanks] {
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]] {
		%tankSwitchNames = LiquidFuel
		%resourceNames = LiquidFuel
		%resourceAmounts  = #$../IFSVol5$
		%visualObjectNames = LiquidFuel,LF,l
	}
}

// Default resources for any IFS-PGT
@PART[*]:HAS[#IFSTankType[PGT]]:FOR[IFSTanks] {
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]] {
		%IFSVHydrogen = 591.073
		@IFSVHydrogen *= #$../IFSTankVolume$
		%IFSVNitrogen = 494.549
		@IFSVNitrogen *= #$../IFSTankVolume$
		%tankSwitchNames = Hydrogen;Nitrogen
		%resourceNames = Hydrogen;Nitrogen
		%resourceAmounts = #$IFSVHydrogen$;$IFSVNitrogen$
		%visualObjectNames = 1H,g;14N,g
		!IFSVHydrogen = 0
		!IFSVNitrogen = 0
	}
}

// Default resources for any IFS-RFC
@PART[*]:HAS[#IFSTankType[RFC]]:FOR[IFSTanks] {
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]] {
		%tankSwitchNames = Uraninite;Actinides
		%resourceNames = Uraninite;Actinides
		%resourceAmounts = #$../IFSTankVolume$;$../IFSTankVolume$
		%visualObjectNames = UO2;An
	}
}


// Last Block, copy and clean variables

@PART[*]:HAS[#IFSTankVolume]:LAST[IFSTanks] {

	@MODULE[InterstellarMeshSwitch]:HAS[#moduleID[IFSFuelMeshSwitcher]]
	{
		// actual visual objects to show/hide
		%objects = #$../MODULE[InterstellarFuelSwitch]/visualObjectNames$
		//the last renders all unused objects hidden
		@objects = #$objects$;$../IFSUnusedVisualObjects$
		// text shown in switcher slider
		%tankSwitchNames = #$../MODULE[InterstellarFuelSwitch]/tankSwitchNames$
		// text shown in editor part details
		%objectDisplayNames = #$../MODULE[InterstellarFuelSwitch]/tankSwitchNames$
		// unused
		%indexNames = #$../MODULE[InterstellarFuelSwitch]/tankSwitchNames$
		//When matching IFS and IFSMeshSwitch, the tankSwitchNames is compared to fuelTankSetups.
		// this is matched to tankSwitchNames of IFS
		%fuelTankSetups = #$../MODULE[InterstellarFuelSwitch]/tankSwitchNames$
	}
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]]
	{
		// copy the names to avoid repetition
		%resourceGui = #$tankSwitchNames$
		// remove temporary variable
		//-visualObjectNames = 0
		-IFSV = 0
	}

	!IFSTankVolume = 0
	!IFSTankType = 0
	!IFSVol5 = 0
	!IFSpureLH2 = 0
	!IFSMtank = 0
	!IFScryoPower = 0
	!IFSTankTypeCDT = 0
	//!IFSUnusedVisualObjects = 0
}


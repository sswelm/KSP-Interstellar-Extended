// Resource Volume as of 2017.07.12
// 5: LiquidFuel, Oxidizer
// 1: Kerosene, LqdOxygen, LqdMethane, LqdHydrogen
// 
//	#######################
//	Cryogenic Dual Tanks
//	#######################

//Tank registration: Legacy or BEFORE[IFSTanks]
//Primary Tank config: FOR[IFSTanks]
//Third party: AFTRER[IFSTanks]
//Cleanup: LAST

// Additions to Tank part Definitions

@PART[CC2???]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = CC
	%IFSUnusedVisualObjects = Al2O3,27Al,Borate,11B,55Cs,12C,B10H14,CaF2,Hydrates,6Li,7Li,6LiD,7LiH,Minerals,Monazite,NaNO3,PVC,Regolith,NaCl,Silicate,23Na,Spodumene

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

@PART[CDT2???]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = CT
	%IFSTankTypeCDT = 1
	%IFSUnusedVisualObjects = Methalox,Hydrolox,Hydrooxi,Methane,Hydrogen,Hydrazine

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

@PART[CT2???]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = CT
	%IFSUnusedVisualObjects = 14NH3,40Ar,12CO2,12CO,2D,B2H6,19F,3He2D,3He,4He,B6H10,14N2H4,1H,1H,H202,Kerosene,84Kr,20Ne,12CH4,14N,15N,16O,18O,3T,H20,D2O,131Xe,l,p,s

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

@PART[IST2???gas]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = PGT
	%IFSUnusedVisualObjects = 14NH3,40Ar,12CO2,12CO,2D,B2H6,19F,3He2D,3He,4He,B6H10,14N2H4,1H,1H,H202,Kerosene,84Kr,20Ne,12CH4,14N,15N,16O,18O,3T,H20,D2O,131Xe,14NO,Air,l,p,s,g

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

@PART[IST2???lqd]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = CT
	%IFSUnusedVisualObjects = 14NH3,40Ar,12CO2,12CO,2D,B2H6,19F,3He2D,3He,4He,B6H10,14N2H4,1H,1H,H202,Kerosene,84Kr,20Ne,12CH4,14N,15N,16O,18O,3T,H20,D2O,131Xe,14NO,Air,l,p,s,g

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

@PART[PGT2???]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = PGT
	%IFSUnusedVisualObjects = Air,14NH3,40Ar,2D,12CO2,12CO,19F,3He,4He,1H,84Kr,12CH4,20Ne,14N,14NO,16O,131Xe

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

@PART[RFC2???]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = RFC
	%IFSUnusedVisualObjects = An,DPL,U,DPL,Fuel,Pu,Th,ThF4,UO2,U,UF4,UxNy

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

@PART[kspiSphericalTank*]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = CT
	%IFSMtank = #$mass$
}

@PART[ifsBigSphereTank*]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = CT
	%IFSMtank = #$mass$
}

//todo: ifsBigSphereTank, IFSHexcan*, KspiInflatableLiquidTank, InterstellarSphereTank, kspiSphericalTank*, IfsWrapperTank*, IfsWrapperCap*

// Initial setup of all tanks

@PART[*]:HAS[#IFSTankVolume]:FOR[IFSTanks]
{
	%IFSVol5 = #$IFSTankVolume$
	@IFSVol5 *= 0.2					// Volume for resources with 5 FU per Liter

	%IFSpureLH2 = #$IFSTankVolume$
	@IFSpureLH2 *= 1.5

	MODULE
	{
		name = InterstellarMeshSwitch
		moduleID = IFSFuelMeshSwitcher
		switcherDescription = #LOC_IFS_FuelSwitch_switcherDescription
		useFuelSwitchModule = true
		affectColliders = false
		orderByIndexNames = true
		debugMode = false
		// rest inserted by AFTER patch
	}

	MODULE
	{
		name = InterstellarFuelSwitch
		moduleID = IFSFuelSwitcher
		//*defaultTank = LFO
		basePartMass = #$../mass$
		baseMassExponent = 2.7
		tweakscaleMassExponent = 3
		displayCurrentTankCost = true
		availableInFlight = true
		availableInEditor = true
		hasSwitchChooseOption = false
		showSwitchButtons = false
		showInfo = true
		hasGUI = false
		adaptiveTankSelection = true
		orderBySwitchName = true
		debugMode = false
		// a identifier and also shown in gui
		//*tankSwitchNames = LiquidFuel
		// what actually goes into tank
		//*resourceNames = LiquidFuel
		// how much
		//*resourceAmounts = #$../IFSVol5$
		// name of visual object for MeshSwitch
		//*visualObjectNames = LiquidFuel
	}
}

// Remove MeshSwitch if the tank def does not have unused visuals (optional, save space)
@PART[*]:HAS[#IFSTankVolume,~IFSUnusedVisualObjects]:FOR[IFSTanks] {
	!MODULE[InterstellarMeshSwitch]:HAS[#moduleID[IFSFuelMeshSwitcher]] {}
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]] {
		hasGUI = true
		hasSwitchChooseOption = true
	}
}

// Default resources for any IFS-CC
@PART[*]:HAS[#IFSTankType[CC]]:FOR[IFSTanks] {
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]] {
		%tankSwitchNames = Lithium;LithiumHydride
		%resourceNames = Lithium;LithiumHydride
		%resourceAmounts = #$../IFSTankVolume$;$../IFSTankVolume$
		%visualObjectNames = 7Li,s;7LiH,s
	}
}

// Default resources for any IFS-CT
@PART[*]:HAS[#IFSTankType[CT]]:FOR[IFSTanks] {
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]] {
		%tankSwitchNames = LiquidFuel;Hydrogen
		%resourceNames = LiquidFuel;LqdHydrogen
		%resourceAmounts = #$../IFSTankVolume$;$../IFSTankVolume$
		%visualObjectNames = LiquidFuel,LF,l;Hydrogen,1H,l
	}
}

// Default resources for any IFS-PGT
@PART[*]:HAS[#IFSTankType[PGT]]:FOR[IFSTanks] {
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]] {
		%IFSVHydrogen = 591.073
		@IFSVHydrogen *= #$../IFSTankVolume$
		%IFSVNitrogen = 494.549
		@IFSVNitrogen *= #$../IFSTankVolume$
		%tankSwitchNames = Hydrogen;Nitrogen
		%resourceNames = Hydrogen;Nitrogen
		%resourceAmounts = #$IFSVHydrogen$;$IFSVNitrogen$
		%visualObjectNames = 1H,g;14N,g
		!IFSVHydrogen = 0
		!IFSVNitrogen = 0
	}
}

// Default resources for any IFS-RFC
@PART[*]:HAS[#IFSTankType[RFC]]:FOR[IFSTanks] {
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]] {
		%tankSwitchNames = Uraninite;Actinides
		%resourceNames = Uraninite;Actinides
		%resourceAmounts = #$../IFSTankVolume$;$../IFSTankVolume$
		%visualObjectNames = UO2;An
	}
}


// Default resources for CDT (on top of CT)
@PART[*]:HAS[#IFSTankTypeCDT]:FOR[IFSTanks] {
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]] {
		//calculate
		%MixLFOF = #$../IFSTankVolume$
		@MixLFOF *= 0.09			// LFO: Volume LiquidFuel
		%MixLFOO = #$../IFSTankVolume$
		@MixLFOO *= 0.11			// LFO: Volume Oxidizer
		%MixHydroloxF = #$../IFSTankVolume$
		@MixHydroloxF *= 0.8
		%MixHydroloxO = #$../IFSTankVolume$
		@MixHydroloxO -= #$MixHydroloxF$
		%MixMethaloxF = #$../IFSTankVolume$
		@MixMethaloxF *= 0.557
		%MixMethaloxO = #$../IFSTankVolume$
		@MixMethaloxO -= #$MixMethaloxF$
		//set
		@tankSwitchNames = #$tankSwitchNames$;LFO;MethaLox;HydroLox
		@resourceNames = #$resourceNames$;LiquidFuel,Oxidizer;LqdMethane,LqdOxygen;LqdHydrogen,LqdOxygen
		@resourceAmounts = #$resourceAmounts$;$MixLFOF$,$MixLFOO$;$MixMethaloxF$,$MixMethaloxO$;$MixHydroloxF$,$MixHydroloxO$
		@visualObjectNames = #$visualObjectNames$;LFO;Methalox;Hydrolox
		//clear
		!MixLFOF = 0
		!MixLFOO = 0
		!MixHydroloxF = 0
		!MixHydroloxO = 0
		!MixMethaloxF = 0
		!MixMethaloxO = 0
	}
}

//When matching IFS and IFSMeshSwitch, the tankSwitchNames is compared to fuelTankSetups.
// Last Block, copy and clean variables
@PART[*]:HAS[#IFSTankVolume]:LAST[IFSTanks] {

	@MODULE[InterstellarMeshSwitch]:HAS[#moduleID[IFSFuelMeshSwitcher]]
	{
		// actual visual objects to show/hide
		//the last renders all unused objects hidden
		%objects = #$../MODULE[InterstellarFuelSwitch]/visualObjectNames$
		@objects = #$objects$;$../IFSUnusedVisualObjects$
		// text shown in switcher slider
		%tankSwitchNames = #$../MODULE[InterstellarFuelSwitch]/tankSwitchNames$
		// text shown in editor part details
		%objectDisplayNames = #$../MODULE[InterstellarFuelSwitch]/tankSwitchNames$
		// unused
		%indexNames = #$../MODULE[InterstellarFuelSwitch]/tankSwitchNames$
		// this is matched to tankSwitchNames of IFS
		%fuelTankSetups = #$../MODULE[InterstellarFuelSwitch]/tankSwitchNames$
	}
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]]
	{
		// copy the names to avoid repetition
		%resourceGui = #$tankSwitchNames$
		// remove temporary variable
		//-visualObjectNames = 0
	}

	!IFSTankVolume = 0
	!IFSTankType = 0
	!IFSVol5 = 0
	!IFSpureLH2 = 0
	//!IFSMtank = 0
	!IFScryoPower = 0
	!IFSTankTypeCDT = 0
	//!IFSUnusedVisualObjects = 0
}


// Resource Volume as of 2017.07.12
// 5: LiquidFuel, Oxidizer
// 1: Kerosene, LqdOxygen, LqdMethane, LqdHydrogen
// 
//	#######################
//	Cryogenic Dual Tanks
//	#######################

//Tank registration: Legacy or BEFORE[IFSTanks]
//Primary Tank config: FOR[IFSTanks]
//Third party: AFTRER[IFSTanks]
//Cleanup: LAST

//Primary setup block common for all tanks (with LiquidFuel)
//Patch for each resource, match by IFSTankType

@PART[CC2???]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = CC

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

@PART[CDT2???]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = CT
	%IFSTankTypeCDT = 1

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

@PART[CT2???]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = CT

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

@PART[IST2???gas]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = PGT

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

@PART[IST2???lqd]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = CT

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

@PART[PGT2???]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = PGT

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

@PART[RFC2???]:HAS[#IFSTankVolume]:FOR[IFSTanks] {
	%IFSTankType = RFC

	%IFSMtank = #$IFSTankVolume$
	@IFSMtank /= 19000
	@mass = #$IFSMtank$

	%IFScryoPower = #$IFSTankVolume$
	@IFScryoPower /= 800		// IFScryoPower: power requirement cryo storage
}

// - common init for all types
// - default resources for each type
// - extra resources

// Initial setup of all tanks
@PART[*]:HAS[#IFSTankVolume]:FOR[IFSTanks]
{
	%IFSVol5 = #$IFSTankVolume$
	@IFSVol5 *= 0.2					// Volume for resources with 5 FU per Liter

	%IFSpureLH2 = #$IFSTankVolume$
	@IFSpureLH2 *= 1.5

	MODULE
	{
		name = InterstellarMeshSwitch
		moduleID = IFSFuelMeshSwitcher
		switcherDescription = #LOC_IFS_FuelSwitch_switcherDescription
		useFuelSwitchModule = true
		affectColliders = false
		orderByIndexNames = true
		debugMode = false
		// rest inserted by AFTER patch
	}

	MODULE
	{
		name = InterstellarFuelSwitch
		moduleID = IFSFuelSwitcher
		//*defaultTank = LFO
		basePartMass = #$../mass$
		baseMassExponent = 2.7
		tweakscaleMassExponent = 3
		displayCurrentTankCost = true
		availableInFlight = true
		availableInEditor = true
		hasSwitchChooseOption = false
		showSwitchButtons = false
		showInfo = true
		hasGUI = false
		adaptiveTankSelection = true
		orderBySwitchName = true
		debugMode = false
		// a identifier and also shown in gui
		//*tankSwitchNames = LiquidFuel
		// what actually goes into tank
		//*resourceNames = LiquidFuel
		// how much
		//*resourceAmounts = #$../IFSVol5$
		// name of visual object for MeshSwitch
		//*visualObjectNames = LiquidFuel
	}
}

// Default resources for any IFS-CT
@PART[*]:HAS[#IFSTankType[CT]]:FOR[IFSTanks] {
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]] {
		%tankSwitchNames = LiquidFuel
		%resourceNames = LiquidFuel
		%resourceAmounts = #$../IFSVol5$
		%visualObjectNames = LiquidFuel
	}
}

// Default resources for CDT (on top of CT)
@PART[*]:HAS[#IFSTankTypeCDT]:FOR[IFSTanks] {
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]] {
		//calculate
		%MixLFOF = #$../IFSTankVolume$
		@MixLFOF *= 0.09			// LFO: Volume LiquidFuel
		%MixLFOO = #$../IFSTankVolume$
		@MixLFOO *= 0.11			// LFO: Volume Oxidizer
		%MixHydroloxF = #$../IFSTankVolume$
		@MixHydroloxF *= 0.8
		%MixHydroloxO = #$../IFSTankVolume$
		@MixHydroloxO -= #$MixHydroloxF$
		%MixMethaloxF = #$../IFSTankVolume$
		@MixMethaloxF *= 0.557
		%MixMethaloxO = #$../IFSTankVolume$
		@MixMethaloxO -= #$MixMethaloxF$
		//set
		@tankSwitchNames = #$tankSwitchNames$;LFO;MethaLox;HydroLox
		@resourceNames = #$resourceNames$;LiquidFuel,Oxidizer;LqdMethane,LqdOxygen;LqdHydrogen,LqdOxygen
		@resourceAmounts = #$resourceAmounts$;$MixLFOF$,$MixLFOO$;$MixMethaloxF$,$MixMethaloxO$;$MixHydroloxF$,$MixHydroloxO$
		@visualObjectNames = #$visualObjectNames$;LFO;Methalox;Hydrolox
		//clear
		!MixLFOF = 0
		!MixLFOO = 0
		!MixHydroloxF = 0
		!MixHydroloxO = 0
		!MixMethaloxF = 0
		!MixMethaloxO = 0
	}
}

//When matching IFS and IFSMeshSwitch, the tankSwitchNames is compared to fuelTankSetups.

@PART[*]:HAS[#IFSTankVolume]:LAST[IFSTanks] {
	@MODULE[InterstellarMeshSwitch]:HAS[#moduleID[IFSFuelMeshSwitcher]]
	{
		// actual visual objects to show/hide
		%objects = #$../MODULE[InterstellarFuelSwitch]/visualObjectNames$
		// this assings all game objects into the last switch so that they are hidden even if unused
		@objects = #$objects$;Methalox,Hydrolox,Hydrooxi,Methane,Hydrogen,Hydrazine
		// text shown in switcher slider
		%tankSwitchNames = #$../MODULE[InterstellarFuelSwitch]/tankSwitchNames$
		// text shown in editor part details
		%objectDisplayNames = #$../MODULE[InterstellarFuelSwitch]/tankSwitchNames$
		// unused
		%indexNames = #$../MODULE[InterstellarFuelSwitch]/tankSwitchNames$
		// this is matched to tankSwitchNames of IFS
		%fuelTankSetups = #$../MODULE[InterstellarFuelSwitch]/tankSwitchNames$
	}
	@MODULE[InterstellarFuelSwitch]:HAS[#moduleID[IFSFuelSwitcher]]
	{
		// copy the names to avoid repetition
		%resourceGui = #$tankSwitchNames$
		// remove temporary variable
		//-visualObjectNames = 0
	}
	!IFSTankVolume = 0
	!IFSTankType = 0
	!IFSVol5 = 0
	!IFSpureLH2 = 0
	//!IFSMtank = 0
	!IFScryoPower = 0
}
